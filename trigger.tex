%% Hello emacs, this is -*- latex -*-
\typeout{ ====================================================================}
\typeout{ This is file trigger.tex, created at 28-Feb-2004 }
\typeout{ Maintained by Andre dos Anjos <Andre.dos.Anjos@cern.ch> }
\typeout{ ====================================================================}

\chapter{O Sistema de Filtragem e Aquisição de dados do ATLAS}
\label{chap:trigger}

O \idx{sistema de filtragem} do experimento ATLAS tem o encargo de separar, em
tempo real, física considerada ordinária para o experimento da rara física de
interesse. A taxa de eventos produzida pelo LHC é da ordem 40 milhões por
segundo, ou 40 MHz em bateladas que durarão cerca de 10 horas (este período é
comumente referido como \eng{run}). Cada evento poderá produzir uma colisão
favorável a física de interesse, embora a grande maioria, mais de 99,9999\%,
represente física já bastante estudada em experimentos anteriores ainda que a
luminosidade do sistema seja tão elevada. Ademais, cada evento detetado pelo
ATLAS produzirá cerca de 1,5 Megabytes em dados, o que torna o problema da
filtragem bastante difícil, já que o fluxo de dados que deve ser analisado por
base de tempo está acima da capacidade de qualquer tecnologia de transporte
(de dados) atual.

Para o experimento ATLAS, o sistema de filtragem será construído em 3 níveis
seqüênciais (veja a Figura~\ref{fig:trigger-sketch}). Cada nível que sucede
refina a decisão do nível anterior através da aquisição de mais dados do
sistema de deteção. O \idx{Primeiro Nível} de filtragem (do inglês
\idxeng{First-Level Trigger}, L1) deverá reduzir a taxa de eventos do LHC para
cerca de 100 kHz apenas, através de técnicas simples de filtragem codificadas
em hardware personalizado. O \idx{Segundo Nível} de filtragem (do inglês
\idxeng{Second-Level Trigger}, L2) reduzirá a taxa de saída do L1 para
aproximadamente 1 kHz utlizando aplicações codificadas em software em
computadores do tipo PC. O \idx{Terceiro Nível} de filtragem ou
\idx{Filtro de Eventos} (do inglês \idxeng{Event Filter}, EF) estará baseado
na mesma tecnologia escolhida para o L2, reduzindo a taxa de entrada de
eventos para aproximadamente 100 Hz através de algoritmos de filtragem mais
eficientes porém com menor desempenho.

\begin{figure}
\begin{center}
\includegraphics[angle=-90,scale=0.8]{trigger-sketch}
\end{center}
\caption{Visão funcional simplificada do sistema de filtragem do experimento
ATLAS.} 
\label{fig:trigger-sketch}
\end{figure}

\section{O Primeiro Nível de Filtragem}

O Primeiro Nível de Filtragem (L1) realiza uma seleção inicial de candidatos à
física de interesse baseado em informações com segmentação reduzida de um
subconjunto dos detetores do ATLAS, os calorímetros e o detetores de múons
\cite{l1-tdr}. Múons com altos valores de \idx{momento transverso} ($p_T$) são
identificados à partir das câmaras de trigger conectadas ao Spectrômetro de
Múons (veja a Seção~\ref{sec:atlas-muon}) na região do barril e da tampa. As
seleções baseadas em calorimetria utilizam uma segmentação reduzida das seções
e.m. e hadrônica, no barril e na tampa. Os objetos procurados usando-se
calorímetros no L1 são elétrons com altos valores de $p_T$ e fótons, jatos,
taus decaindo em cascatas hadrônicas, grandes quantidades de energia faltante
ou energia transversa total. No caso da seleção de elétrons e fótons ou
hádrons e taus, isolamento em energia pode ser requisitado.

Para gerar os sinais de filtragem necessários ao L1, o sistema de leitura de
dados dos calorímetros é equipado com somadores rápidos que aglomeram o sinal
de 1 ou mais células destes detetores para gerar macrocélulas de filtragem
denominadas \idx{torres de filtragem} (do inglês \idxeng{Trigger Towers},
TT). O sistema de múons também possuem circuitos equivalentes que determinam a
ocorrência de traços com altos valores de $p_T$. 

Os eventos selecionados pelo L1 são lidos pela eletrônica primária dos
detetores por \eng{drivers} denominados \idxeng{ReadOut Drivers} ou
\idx{ROD}'s. Cerca de 1.600 ROD's serão necessários para ler todos os dados do
detetor, ou seja, aproximadamente $10^7$ canais independentes. Vários canais
de leitura são multiplexados em cada ROD. Bancos de memória primários,
chamados de \idxeng{derandomizers} garante um fluxo contínuo dos dados aos
ROD's apesar da irregularidade da aceitação de eventos proporcionado pelo L1.

Os dados completos de eventos selecionados são guardados em bancos de memória
denominados \idxeng{ReadOut Buffers} (ROB's) até que o evento seja rejeitado
pelo L2 ou, no caso de ser aceito por este nível, até que os dados sejam
transferidos para o terceiro nível de filtragem (EF). O processo de mover os
dados dos ROB's para of EF é chamado de \idx{construção do evento} (do inglês,
\idxeng{Event Building}, EB). Enquanto até a fase de construção do evento os
dados estão segmentados em ROB's, após esta etapa o evento completo estará
guardado em um único banco de memória e acessível a um processador do EF.

\paragraph{Regiões de Interesse} Além do disparo dado pelo L1 à eletrônica de
leitura, este nível de filtragem deve enviar ao L2 um mapa dos objetos de
interesse encontrados no detetor durante a avaliação do evento. Este mapa
indica, na precisão do L1, as \idx{regiões de interesse} no detetor (do inglês
\idxeng{Region of Interest}, RoI) que contribuíram para a seleção, os tipos
de objetos encontrados e o valor mínimo (\eng{threshold}) de $p_T$ que
satisfazem. Informações de RoI's secundárias (que não contribuíram para a
decisão do L1, mas que excitaram notavelmente o detetor) também podem ser
transmitidas ao L2, provendo uma maior capacidade de decisão a este nível.

A Figura~\ref{fig:l1-context} mostra um diagrama do tipo ``caixa-preta''
indicando os sinais de entrada e saída do L1. A este sistema são injetados os
sinais provenientes da eletrônica de leitura, dos sistemas de filtragem
diretamente acoplados aos detetores e do LHC (\eng{clock} de 40 MHz) e
colhidos sinais que são encaminhados para o L2, para a eletrônica de aquisição
e para o sistema de monitoração central.

\begin{figure}
\begin{center}
\includegraphics[scale=0.75,angle=-90]{l1-blackbox}
\end{center}
\caption{Diagrama simplificado dos sinais de entrada e saída do L1.}
\label{fig:l1-context}
\end{figure}

A Figura~\ref{fig:l1-functional} mostra um diagrama funcional simplificado do
L1. Nesta figura é possível identificar processadores específicos para os
sinais provenientes dos detetores. Um \idx{processador central de filtragem}
(marcado na figura como \idxeng{Central Trigger Processor}) é responsável pela
decisão final e pela emissão do sinal para o L2 e para o sistema de
distribuição de tempo, disparo e controle (indicado como \idxeng{Timming,
Trigger and Control distribution}, ou TTC), que gera finalmente o sinal para a
leitura dos dados do detetor. Dentre os componentes do TTC está o
\idx{construtor de RoI's} (do inglês \idxeng{RoI Builder}, RoIB) que monta o
mapa de RoI's destacada pelo L1 e comunica, através de uma conexão serial
rápida tipo S-Link, estes dados ao L2.

\begin{figure}
\begin{center}
\includegraphics[scale=0.8]{l1-functional}
\end{center}
\caption{Diagrama em blocos indicando as principais funções do L1.}
\label{fig:l1-functional}
\end{figure}

\section{Os Altos Níveis de Filtragem, Aquisição de Dados e Controle}
\label{sec:hlt-daq}

O \idx{sistema de aquisição de dados} do ATLAS (do inglês \idxeng{Data
Acquisition System}, \idx{DAQ}) é composto pelos componentes que estão
encarregados da transmissão e manipulação dos dados produzidos pelo detetor
\cite{hlt-tdr}. O DAQ trabalha em cooperação com os diversos níveis de
filtragem e controle no experimento de forma a garantir a correção dos dados
transmitidos e a minimização do tempo-morto despendido na transferência de
informação do sistema. A cadeia de operação do DAQ é iniciada por um disparo
do L1 para a leitura de dados executada nos ROD's. Cada ROD é ligado, através
de uma conexão S-Link\footnote{Conexão ponto-a-ponto com taxa máxima de
transferência de 160 megabits por segundo.}, a somente um ROB. Cada ROB pode
receber dados de um ou no máximo 3 ROD's, dependendo da configuração final do
experimento.

Cabe aos \idx{Altos Níveis de Filtragem} (do inglês \idxeng{High-Level
Triggers}, \idx{HLT}), analisando de forma ótima os dados presentes nos ROB's,
decidir, disparando mais uma vez o DAQ sobre o futuro de cada evento aceito
pelo L1. O conjunto HLT-DAQ-Controle deverá funcionar harmoniosamente sobre
uma mesma base computacional e utilizando o mesmo conjunto de ferramentas para
a codificação, análise e depuração de problemas que possam ocorrer. Por esta
razão, esta união de produtos de \eng{hardware} e \eng{software} é considerado
um macro-sistema do experimento. Este sistema pode ser subdividido em 4
partes:

\begin{itemize}
\item \textbf{\idx{sistema de controle do detetor} ou \idxeng{Detector Control
System}, \idx{DCS}}: responsável pela operação coerente e segura (no que tange
radiação, controle de altas tensões, etc.) do detetor ATLAS e pelo
interfaceamento com sistemas externos e serviços incluindo o acelerador
LHC. Uma vez que este tópico não está diretamente envolvido neste trabalho, o
abordaremos somente em caráter introdutório;

\item \textbf{\idxeng{online}}: é responsável por todos os aspectos de
operação e controle durante a aquisição de dados do experimento e durante
\eng{runs} de teste e calibração;

\item \textbf{\idx{fluxo de dados} ou \idxeng{Dataflow}}: este sistema é
responsável por receber os dados do detetor, servir um subconjunto destes
dados ao HLT e transportar os dados de eventos selecionados em última
instância para armazenagem em mídia permanente;

\item \textbf{\idx{filtros de alto nível} ou \idx{HLT}}: são responsáveis pela
seleção de eventos após o L1, envolvendo a redução da taxa de eventos e a
classificação de todos os eventos aceitos.

\end{itemize}

\subsection{O Sistema de Controle do Detetor}
\label{sec:dcs}

O DCS supervisa todos os componentes de \eng{hardware} do arranjo
experimental, incluindo todos os sistemas de deteção do ATLAS e a
infraestrutura experimental comum a todos os outros sistemas. O DCS também se
comunica com sistemas externos como a infraestrutura de serviços do CERN e,
mais notavelmente, com o acelerador LHC.

Aspectos de seguranção são tratados pelo DCS somente no nível de menor
severidade. Este trabalho tange principalmente questões ligadas ao
seqüenciamento de operações ou a requisição que condições específicas
prevaleçam antes de permitir que outros procedimentos sejam
executados. Ferramentas para a construção de interdependências, tanto em
\eng{hardware} quanto em \eng{software} são providas pelo DCS. Monitoração e
prevenção de situações que poderiam causar danos maiores ao detetor e a vida
das pessoas são de responsabilidade de sistemas dedicados - o \idx{Sistema de
Segurança do Detetor} (do inglês \idxeng{Detetor Safety System}, \idx{DSS}) e
do sistema de segurança e alarme do CERN respectivamente. O DCS interagem com
ambos os sistemas.

Todas as ações iniciadas pelo operador e todos os erros, avisos e alarmes que
implicam em falha de \eng{hardware} do detetor são gerenciadas pelo DCS. Este
sistema provê informação \eng{online} da situação presente, com a
granularidade necessária para uma operação centralizada do sistema. A
interação dos \eng{experts} em detetores com suas máquinas também é feita
através do DCS, que continuamente monitora todos os parâmetros operacionais,
guiando o operador e sinalizando comportamento anormal no maquinário. O DCS
também será capaz de acionar procedimentos automáticos para trazer o sistema
de deteção para um estado seguro, se necessário for.

No que tange a operação do experimento, a interação com o sistema de aquisição
de dados é de importância primária. A boa qualidade da física gravada em mídia
permanente depende de uma sincronização absoluta entre o DAQ e o DCS; ambos os
sistemas são complementares. O DAQ lida com eventos caracterizados por um
número, enquanto que o DCS guarda o estado operacional do detetor enquanto os
dados estão sendo adquiridos, correlacionando os números dos eventos com a
qualidade da aquisição, que finalmente é avaliada \eng{offline}.

Algumas partes do detetor operarão continuamente pois qualquer interrupção
pode ser custosa em tempo, fundos ou na performance do sistema
global. Portanto, a supervisão do sistema de deteção é necessária
constantemente. Por outro lado, o DAQ é somente necessário durante a aquisiçào
de dados ou durante \eng{runs} de monitoração, calibração ou teste. Assim
sendo, o DCS precisa ter completa independência funcional, ainda que, ao mesmo
tempo, este quesito não deva imperativamente acarretar em limites operacionais
com o DAQ.

\subsection{O Sistema \textit{Online}}
\label{sec:online}

O sistema \idxeng{online} engloba os programas para configurar, controlar e
monitorar o sistema de filtragem e aquisição de dados do ATLAS (do inglês
\eng{Trigger and Data Acquisition}, TDAQ), excluindo o gerenciamento,
processamento e transporte de dados físicos. É um conjunto de ferramentas
personalizável que provê a ``cola'' que une entradas e saídas dos outros
sistemas. O sistema \eng{online} não contém elementos que são específicos a
detetores pois é também utilizado por todos os sistemas de instrumentação da
aquisição de dados de forma transparente. Ele coopera com outros sub-sistemas
e interfaces para a leitura do detetor, DCS, L1,
\eng{Dataflow}, HLT, \eng{Offline} e o interfaceamento com operadores dos
\eng{runs}.

Um dos papéis importantes do sistema \eng{online} é prover serviços para guiar
o TDAQ na sua inicialização e finalização de forma que executem de maneira
ordenada. Este sistema é responsável pela sincronização dos estados de um
\eng{run} para todo o sistema de filtragem, aquisição e supervisão. Estes
procedimentos são projetados para levar o menor tempo possível a serem
executados reduzindo tempos-mortos pois isto afeta diretamente a quantidade de
dados que pode ser adquirida em um período do LHC. Ferramentas de verificação
e diagnóstico ajudam a detetar problemas de maneira precoce e
eficiente. Bancos de dados com a configuração do sistema são fornecidos
contendo um grande número de parâmetros que descrevem a topologia do sistema,
os componentes de \eng{hardware} e \eng{software} assim como os modos e ordem
de execução. Durante a aquisição, componentes especilizados capturam e servem
informação ligada a monitoração dos diversos processos do experimento como
dados estatísticos, histogramas ou parâmetros de rejeição, assim como
mensagens de erro e diagnóstico enviadas pelas diversas aplicações. Interfaces
(gráficas) aos operadores os permitem configurar e controlar diversas
funcionalidades do experimento. Estas interfaces fornecem visões simplificadas
de vários sub-sistemas durante um \eng{run}.

\subsubsection{Arquitetura do Sistema \eng{Online}}
\label{sec:online-arch}

O projeto do sistema \eng{online} é baseado numa arquitetura de componentes,
que respeitam o modelo cliente-servidor. Os componentes podem ser dividos em 3
grupos que incluem cada, um conjunto de pacotes. Cada um dos pacotes está
associado a um grupo de funções para este sistema e provê um conjunto definido
de serviços. Os serviços possuem interfaces bem definidas e são desacoplados
entre si.

\paragraph{Controle} contém pacotes para o controle do sistema de
aquisição, filtragem e deteção. Os pacotes de controle existem para propiciar
ao TDAQ capacidades de inicialização e finalização, distribuição de comandos,
sincronização, manuseio de erros e verificação do sistema.

O sistema de controle de dispositivos e aplicações do \eng{online} é baseado
em uma máquina de estados finitos global mostrada na
figura~\ref{fig:online-fsm}. Todos os dispositivos do sistema devem
obedecê-la, enviando avisos e erros caso falhem em cumprir as ordens do
operador.

\begin{figure}
\begin{center}
\includegraphics[scale=0.7]{online-fsm}
\end{center}
\caption{A máquina de estados finitos utilizada por todos os componentes do
TDAQ e detetores do ATLAS.}
\label{fig:online-fsm}
\end{figure}

\paragraph{Bancos de dados} contém pacotes para a configuração do TDAQ e
detetores. Os pacotes de configuração existem para propiciar parâmetros de
configuração do sistema, sua descrição e acesso e registro operacional de
informações durante a aquisição de dados. Há também componentes que provêm
acesso de leitura e escrita a bancos de dados que descrevem as condições do
feixe provido pelo LHC e do detetor.

\paragraph{Compartilhamento de informação} contém pacotes para o
compartilhamento de informação no TDAQ. Os componentes destes pacotes podem
anunciar erros, publicar estados, estatística e histogramas construídos pelos
sub-sistemas do TDAQ e pelos detetores.

\typeout{ *************** End of file trigger.tex *************** }
